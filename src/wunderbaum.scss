/*!
 * Wunderbaum style sheet (generated from wunderbaum.scss)
 * Copyright (c) 2021-2023, Martin Wendt. Released under the MIT license.
 * @VERSION, @DATE (https://github.com/mar10/wunderbaum)
 */
@use "sass:meta";

// ----------------------------------------------------------------------------
// --- Define default colors and settings

$font-stack: Helvetica, sans-serif;

// Basic Theme Colors
$error-color: #b5373b;
$node-text-color: #56534c;
$border-color: $node-text-color;
$bg-highlight-color: #26a0da;
$header-color: #dedede;
$background-color: white;
$alternate-row-color: #f7f7f7; // #fcfcfc;
$alternate-row-color-hover: #f3f3f3; //#f7fcfe;
$focus-border-color: #275dc5;

// derived
$drop-source-color: adjust-color($node-text-color, $lightness: 50%);
$drop-target-color: adjust-color($bg-highlight-color, $lightness: 40%);
$dim-color: adjust-color($node-text-color, $lightness: 20%);
$error-background-color: adjust-color($error-color, $lightness: 45%);
// @debug $dim-color;
$hover-color: adjust-color($bg-highlight-color, $lightness: 48%); // #f7f7f7;
$hover-border-color: $hover-color;
$grid-color: #dedede;
$active-color: #e5f3fb;
$active-cell-color: adjust-color($bg-highlight-color, $lightness: 20%);
$active-border-color: #70c0e7;
$active-hover-color: #dceff8;
$active-hover-border-color: $bg-highlight-color;
$active-column-color: $hover-color;
$active-header-column-color: adjust-color($header-color, $lightness: -10%);
// @debug $active-header-column-color;
$filter-dim-color: #dedede;
$filter-submatch-color: #868581;

$row-outer-height: 22px;
$row-inner-height: $row-outer-height - 2; // outer height minus border size
$row-padding-y: ($row-outer-height - $row-inner-height) / 2;
$col-padding-x: 2px; // on each side within span.wb-col

$icon-outer-height: $row-inner-height;
$icon-outer-width: 20px;
$icon-height: 16px;
$icon-width: 16px;
$icon-padding-y: ($icon-outer-height - $icon-height) / 2;
$icon-padding-x: ($icon-outer-width - $icon-width) / 2;

$header-height: $row-outer-height;

// PyCharm:
// $level-rainbow: rgba(255, 255, 232, 1), rgba(240, 255, 240, 1),
//   rgba(255, 240, 255, 1), rgba(234, 253, 253, 1);
// VS-Code_
// $level-rainbow: rgba(255, 255, 64, 0.07), rgba(127, 255, 127, 0.07),
//   rgba(255, 127, 255, 0.07), rgba(79, 236, 236, 0.07);
// Slightly stronger*
$level-rainbow: rgb(255, 255, 201), rgb(218, 255, 218), rgb(255, 217, 254),
  rgb(204, 250, 250);

// ----------------------------------------------------------------------------
// --- Define CSS variables with calculated default values

:root {
  // --wb-font-stack: #{meta.inspect($font-stack)};

  // Basic Theme Colors
  --wb-error-color: #{$error-color};
  --wb-node-text-color: #{$node-text-color};
  --wb-border-color: #{$border-color};
  --wb-bg-highlight-color: #{$bg-highlight-color};
  --wb-header-color: #{$header-color};
  --wb-background-color: #{$background-color};
  --wb-alternate-row-color: #{$alternate-row-color};
  --wb-alternate-row-color-hover: #{$alternate-row-color-hover};
  --wb-focus-border-color: #{$focus-border-color};

  // derived
  --wb-drop-source-color: #{$drop-source-color};
  --wb-drop-target-color: #{$drop-target-color};
  --wb-dim-color: #{$dim-color};
  --wb-error-background-color: #{$error-background-color};
  --wb-hover-color: #{$hover-color};
  --wb-hover-border-color: #{$hover-border-color};
  --wb-grid-color: #{$grid-color};
  --wb-active-color: #{$active-color};
  --wb-active-cell-color: #{$active-cell-color};
  --wb-active-border-color: #{$active-border-color};
  --wb-active-hover-color: #{$active-hover-color};
  --wb-active-hover-border-color: #{$active-hover-border-color};
  --wb-active-column-color: #{$active-column-color};
  --wb-active-header-column-color: #{$active-header-column-color};
  --wb-filter-dim-color: #{$filter-dim-color};
  --wb-filter-submatch-color: #{$filter-submatch-color};

  --wb-row-outer-height: #{$row-outer-height};
  --wb-row-inner-height: #{$row-inner-height};
  --wb-row-padding-y: #{$row-padding-y};
  --wb-col-padding-x: #{$col-padding-x};

  --wb-icon-outer-height: #{$icon-outer-height};
  --wb-icon-outer-width: #{$icon-outer-width};
  --wb-icon-height: #{$icon-height};
  --wb-icon-width: #{$icon-width};
  --wb-icon-padding-y: #{$icon-padding-y};
  --wb-icon-padding-x: #{$icon-padding-x};

  --wb-header-height: #{$header-height};
}

// ----------------------------------------------------------------------------
// --- SCSS Rules

div.wunderbaum {
  box-sizing: border-box;
  height: 100%; // fill parent container
  min-height: 4px;
  background-color: --wb-background-color;
  margin: 0;
  padding: 0;

  font-family: --wb-font-stack;
  font-size: 14px;

  color: var(--wb-node-text-color);
  border: 2px solid var(--wb-border-color);
  border-radius: 4px;
  background-clip: content-box; // Keep bg color outside rounded borders?
  overflow-x: auto;
  // TODO:auto would be better, but may cause unwanted effects when auto-resizing?
  // overflow-y: auto;
  overflow-y: scroll;
  // scroll-behavior: smooth;

  // Focus border is generated by the browsers per default:
  &:focus,
  &:focus-within {
    border-color: --wb-focus-border-color;
    // outline-style: none;
  }

  &.wb-disabled {
    opacity: 0.7;
    pointer-events: none;
  }

  div.wb-list-container {
    position: relative;
    // overflow: auto;
    min-height: 4px;
    // height: calc(100% - #{$header-height});  // didn't work. Using JS instead
  }

  /* --- FIXED-COLUMN --- */

  div.wb-header {
    position: sticky;
    top: 0;
    z-index: 2;
  }

  div.wb-header,
  div.wb-list-container {
    overflow: unset;
  }

  // }
  // --- Header and node list ---
  div.wb-row {
    position: absolute;
    width: 100%;
    height: --wb-row-outer-height;
    line-height: --wb-row-outer-height;
    border: 1px solid transparent;
  }

  /* Fixed column must be opaque, i.e. have the bg color set. */
  &.wb-fixed-col {
    /* Sticky firdt column (header and nodes) */
    span.wb-col:first-of-type {
      position: sticky;
      left: 0;
      z-index: 1;
      background-color: --wb-background-color;
    }

    div.wb-header {
      span.wb-col:first-of-type {
        background-color: --wb-header-color;
      }
    }
    div.wb-node-list div.wb-row {
      &.wb-active span.wb-col:first-of-type,
      &.wb-selected span.wb-col:first-of-type {
        background-color: --wb-active-color;
      }
      &.wb-active:hover span.wb-col:first-of-type,
      &.wb-selected:hover span.wb-col:first-of-type {
        background-color: --wb-active-hover-color;
      }
      &:hover span.wb-col:first-of-type {
        background-color: --wb-hover-color;
      }
    }

    &:not(:focus-within),
    &:not(:focus) {
      div.wb-node-list div.wb-row {
        &.wb-active span.wb-col:first-of-type,
        &.wb-selected span.wb-col:first-of-type {
          background-color: grayscale($active-color);
          border-color: grayscale($active-border-color);
          &:hover span.wb-col:first-of-type {
            background-color: grayscale($active-hover-color);
          }
        }
      }
    }
  }

  // --- Node List Only ---

  // Dim some colors if tree has no focus
  &:not(:focus-within),
  &:not(:focus) {
    div.wb-node-list div.wb-row {
      &.wb-active,
      &.wb-selected {
        background-color: grayscale($active-color);
        border-color: grayscale($active-border-color);

        &:hover {
          background-color: grayscale($active-hover-color);
        }
      }
    }
  }

  &.wb-alternate div.wb-node-list {
    div.wb-row:nth-of-type(even):not(.wb-active):not(.wb-selected) {
      background-color: --wb-alternate-row-color;

      &:hover {
        background-color: --wb-alternate-row-color-hover;
      }
    }
  }

  div.wb-node-list {
    div.wb-row {
      &:hover {
        background-color: --wb-hover-color;
      }

      &.wb-active,
      &.wb-selected {
        background-color: --wb-active-color;

        // border-color: --wb-active-border-color;
        &:hover {
          background-color: --wb-active-hover-color;
          // border-color: --wb-active-hover-border-color;
        }
      }

      &.wb-focus:not(.wb-active) {
        border-style: dotted;
        border-color: --wb-active-border-color;
      }

      &.wb-active {
        // background-color: --wb-active-hover-color;
        border-style: solid;
        border-color: --wb-active-border-color;

        &:hover {
          // background-color: --wb-active-hover-color;
          border-color: --wb-active-hover-border-color;
        }
      }

      &.wb-loading {
        font-style: italic;
      }

      &.wb-busy,
      i.wb-busy,
      .wb-col.wb-busy {
        font-style: italic;

        // For our stripe pattern, we want a frictionless transition at
        // the bottom, when repeating in y-direction:
        // h: height of row = 22px
        // d: spacing between stripe pairs (white + gray)
        // Calculate the spacing that will lead to a minimal quadratic
        // pattern with a height of h pixels:
        //
        //     (2 * d)^2 = 2 * h^2
        // =>  d = sqrt(2 * h^2) / 2
        //       = 15.56px
        // We use the half distance to get a finer stripe pattern:
        //     d/2 = 7.78
        background: repeating-linear-gradient(
          45deg,
          // $hover-color,
          // $hover-color 3.88px,
          transparent,
          transparent 3.88px,
          $grid-color 3.88px,
          $grid-color 7.78px
        );
        animation: wb-busy-animation 2s linear infinite;
      }

      &.wb-error,
      &.wb-status-error {
        color: --wb-error-color;
      }
    }
  }

  // --- HEADER ---

  div.wb-header {
    position: sticky;
    height: --wb-header-height;
    border-bottom: 1px solid var(--wb-border-color);
    padding: 0;
    background-color: --wb-header-color;

    span.wb-col {
      font-weight: bold;
      // &::after {
      //   content: "|";
      // }
      overflow: visible; // allow resizer to overlap next col
    }

    // <span class='wb-col'> contains <span class='wb-col-title'> and <span class='wb-col-resizer'>
    span.wb-col-title {
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    span.wb-col-resizer {
      position: absolute;
      top: 0;
      // left: auto;
      right: -1px;
      width: 3px;
      // float: right;
      border: none;
      border-right: 2px solid var(--wb-border-color);
      height: 100%;
      cursor: col-resize;
    }
  }

  span.wb-col {
    position: absolute;
    display: inline-block;
    // text-overflow: ellipsis;
    overflow: hidden;
    height: --wb-row-inner-height;
    line-height: --wb-row-inner-height;
    padding: 0 $col-padding-x;
    border-right: 1px solid $grid-color;
    white-space: nowrap;

    &:last-of-type {
      border-right: none;
    }
  }

  span.wb-node {
    user-select: none;
    // &:first-of-type {
    //   margin-left: 8px; // leftmost icon gets a little margin
    // }

    i.wb-checkbox,
    i.wb-expander,
    i.wb-icon,
    i.wb-indent {
      height: --wb-icon-outer-height;
      width: --wb-icon-outer-width;
      padding: --wb-icon-padding-y --wb-icon-padding-x;
      display: inline-block;
    }

    /* Fix Bootstrap Icon alignment */
    i.bi::before {
      vertical-align: baseline;
    }

    img.wb-icon {
      width: --wb-icon-width;
      height: --wb-icon-height;
      padding: --wb-icon-padding-y --wb-icon-padding-x;
      // margin-top: --wb-icon-padding-y;
    }

    i.wb-indent {
      // border-left: 1px solid gray;
      &::before {
        content: "\00a0";
      }
    }

    i.wb-expander.wb-spin,
    i.wb-icon.wb-spin {
      height: unset; // Prevent wobble
      width: unset;
      padding: 0 3px;
      animation: wb-spin-animation 2s linear infinite;
    }

    span.wb-title {
      min-width: 1em;
      // display: inline-block; // fix vertical offset on Chrome?
      vertical-align: top;
      overflow-x: hidden;
      display: inline-block;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
  }

  /* --- GRID --- */

  &.wb-grid {
    div.wb-header {
      div.wb-row {
        span.wb-col {
          &:hover {
            background-color: --wb-active-header-column-color;
          }
        }
      }
    }

    &.wb-cell-mode div.wb-header div.wb-row span.wb-col {
      &.wb-active {
        background-color: --wb-active-hover-color;
      }
    }

    div.wb-node-list div.wb-row {
      border-bottom-color: --wb-grid-color;

      &:hover:not(.wb-active):not(.wb-selected) {
        background-color: --wb-hover-color;
        // border-color: --wb-hover-border-color;
      }

      &.wb-active {
        border-bottom-color: --wb-active-border-color;
      }

      span.wb-col {
        border-right: 1px solid $grid-color;

        input.wb-input-edit,
        > input[type="color"],
        > input[type="date"],
        > input[type="datetime"],
        > input[type="datetime-local"],
        > input[type="email"],
        > input[type="month"],
        > input[type="number"],
        > input[type="password"],
        > input[type="search"],
        > input[type="tel"],
        > input[type="text"],
        > input[type="time"],
        > input[type="url"],
        > input[type="week"],
        > select {
          width: 100%;
          max-height: --wb-row-inner-height;
          border: none;
        }

        > input:focus,
        > select:focus {
          border: 1px dashed $active-border-color;
        }
      }

      // input[type="number"]::-webkit-inner-spin-button,
      // input[type="number"]::-webkit-outer-spin-button {
      //   -webkit-appearance: none;
      //   margin: 0;
      // }
    }

    &.wb-cell-mode {
      div.wb-row:not(.wb-colspan) {
        &.wb-active {
          span.wb-col.wb-active {
            background-color: grayscale($active-cell-color);
          }
        }
      }
    }
    &.wb-cell-mode:focus-within,
    &.wb-cell-mode:focus {
      div.wb-row:not(.wb-colspan):not(.wb-selected) {
        // background-color: --wb-background-color;

        span.wb-col.wb-active {
          background-color: --wb-active-column-color;
        }

        &.wb-active {
          background-color: --wb-active-column-color;

          span.wb-col.wb-active {
            background-color: --wb-active-cell-color;
          }
        }
      }
    }

    &.wb-alternate div.wb-node-list {
      div.wb-row:nth-of-type(even):not(.wb-active):not(.wb-selected) {
        background-color: --wb-alternate-row-color;

        &:hover {
          background-color: --wb-alternate-row-color-hover;
        }
      }
    }

    // Dim some colors if tree has no focus
    &:not(:focus-within),
    &:not(:focus) {
      div.wb-node-list div.wb-row {
        border-bottom-color: grayscale($grid-color);
      }
    }
  }

  /* --- FILTER --- */

  &.wb-ext-filter-dim,
  &.wb-ext-filter-hide {
    div.wb-node-list div.wb-row {
      color: --wb-filter-dim-color;

      &.wb-submatch {
        color: --wb-filter-submatch-color;
      }

      &.wb-match {
        color: var(--wb-node-text-color);
      }
    }
  }

  // /* --- INPUT controls in grid --- */
  // &.wb-lean-input div.wb-node-list div.wb-row span.wb-col {
  //   input {
  //     border-color: red;
  //   }
  // }

  /* --- DND --- */

  div.wb-row.wb-drag-source {
    opacity: 0.5;

    .wb-node {
      background-color: --wb-drop-source-color;
    }
  }

  div.wb-row.wb-drop-target {
    overflow: visible;

    .wb-node {
      background-color: --wb-drop-target-color;
      overflow: visible;

      // z-index: 1000;
      .wb-icon {
        position: relative;
        overflow: visible;

        &::after {
          // use ::after, because ::before is used by icon fonts
          // vertical-align: baseline;
          position: absolute;
          z-index: 1000;
          content: url(../docs/assets/drop_marker_16x32.png);
          left: 0; //-$icon-outer-width;
          top: ($row-outer-height - 16) / 2;
        }
      }
    }
  }

  // div.wb-row.wb-drop-target.wb-drop-after .wb-node {
  //   border-bottom: 1px dotted #b5373b;
  //   translate: 0 3px;
  // }
  // div.wb-row.wb-drop-target.wb-drop-before .wb-node,
  // div.wb-row.wb-drop-target.wb-drop-after + div.wb-row .wb-node {
  //   border-top: 1px dotted #b5373b;
  //   translate: 0 -3px;
  // }

  div.wb-row.wb-drop-target.wb-drop-before .wb-node .wb-icon::after,
  div.wb-row.wb-drop-target.wb-drop-after .wb-node .wb-icon::after {
    content: url(../docs/assets/drop_marker_insert_16x64.png);
    left: 0; // $icon-outer-width * 1.5;
    top: ($row-outer-height - 16) / 2 - $row-outer-height / 2;
  }

  div.wb-row.wb-drop-target.wb-drop-after .wb-node .wb-icon::after {
    top: ($row-outer-height - 16) / 2 + $row-outer-height / 2;
  }

  /* --- SPECIAL EFFECTS --- */

  /* Colorize indentation levels. */
  &.wb-rainbow {
    @for $i from 1 through length($level-rainbow) {
      i.wb-expander:nth-child(#{length($level-rainbow)}n + #{$i}),
      i.wb-indent:nth-child(#{length($level-rainbow)}n + #{$i}) {
        background: nth($level-rainbow, $i);
      }
    }
  }

  /* Fade out expanders, when container is not hovered or active */
  &.wb-fade-expander {
    i.wb-expander {
      // only text-alpha is animated, since we want to keep the background color
      // transition: opacity 1.5s;
      // opacity: 0;
      transition: color 1.5s;
      color: rgba($node-text-color, 0);
    }

    div.wb-row.wb-loading i.wb-expander,
    &:hover i.wb-expander,
    &:focus i.wb-expander,
    &:focus-within i.wb-expander,
    [class*="wb-statusnode-"] i.wb-expander {
      transition: color 0.6s;
      color: var(--wb-node-text-color);
    }
  }

  /* Skeleton */
  div.wb-row.wb-skeleton {
    span.wb-title,
    i.wb-icon {
      animation: wb-skeleton-animation 1s linear infinite alternate;
      border-radius: 0.25em;
      color: transparent;
      opacity: 0.7;
      // max-width: 20px;
    }
  }

  /* Auto-hide checkboxes unless selected or hovered */
  &.wb-checkbox-auto-hide {
    i.wb-checkbox {
      visibility: hidden;
    }

    .wb-row:hover i.wb-checkbox,
    .wb-row.wb-selected i.wb-checkbox {
      visibility: unset;
    }

    &:focus,
    &:focus-within {
      .wb-row.wb-active i.wb-checkbox {
        visibility: unset;
      }
    }
  }
}

/* --- TOOL CLASSES --- */

.wb-helper-center {
  text-align: center;
}

.wb-helper-disabled {
  color: --wb-dim-color;
}

.wb-helper-hidden {
  display: none;
}

.wb-helper-invalid {
  color: --wb-error-color;
}

.wb-helper-lazy-expander {
  color: --wb-bg-highlight-color;
}

.wb-helper-link {
  cursor: pointer;
}

.wb-no-select {
  user-select: none;
  -webkit-user-select: none;

  span.wb-title {
    user-select: contain;
    -webkit-user-select: contain;
  }
}

// .wb-helper-edit-text {
//   // content-editable: true;
// }

/* RTL support */
.wb-helper-start,
.wb-helper-start > input {
  text-align: left;
}

.wb-helper-end,
.wb-helper-end > input {
  text-align: right;
}

.wb-rtl {
  .wb-helper-start,
  .wb-helper-start > input {
    text-align: right;
  }

  .wb-helper-end,
  .wb-helper-end > input {
    text-align: left;
  }
}

/* Class 'wb-tristate' is used to mark checkboxes that should toggle like
 *   indeterminate -> checked -> unchecked -> indeterminate ...
 */
// input[type=checkbox].wb-tristate {
// }
// tri-state checkbox in indeterminate state
.wb-col input[type="checkbox"]:indeterminate {
  color: --wb-dim-color;
  background-color: red;
}

.wb-col input:invalid {
  // border-color: --wb-error-color;
  color: --wb-error-color;
  background-color: --wb-error-background-color;
}

@keyframes wb-spin-animation {
  0% {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(1turn);
  }
}

@keyframes wb-skeleton-animation {
  0% {
    background-color: hsl(200, 20%, 70%);
  }

  100% {
    background-color: hsl(200, 20%, 95%);
  }
}

@keyframes wb-busy-animation {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 0 $row-outer-height;
  }
}
